<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prediksi Penyakit Kulit Wajah</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
        #preview { max-width: 224px; max-height: 224px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .result { margin-top: 20px; font-size: 1.1em; }
        .card-product { margin-bottom: 15px; }
        .card-product img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="my-4 text-center">Prediksi Penyakit Kulit Wajah (ONNX)</h2>
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <input type="file" id="imageInput" accept="image/*" class="form-control mb-3">
            <img id="preview" src="#" alt="Preview" style="display:none;">
            <button id="predictBtn" class="btn btn-primary mt-2" disabled>Prediksi</button>
            <div class="result" id="result"></div>
        </div>
    </div>
</div>

<script>
const categories = [
    "Acne", "Blackheads", "Dark Spots", "Normal Skin", "Oily Skin", "Wrinkles"
];

let imageTensor;

// Load ONNX model
let session;
ort.InferenceSession.create('best_skin_model.onnx').then(s => {
    session = s;
    document.getElementById('predictBtn').disabled = false;
});

// Image preprocessing: resize to 224x224, normalize to [-1,1] (MobileNetV2)
function preprocessImage(img, size=224) {
    let canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    let ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, size, size);
    let imageData = ctx.getImageData(0, 0, size, size);
    let {data} = imageData;
    let arr = new Float32Array(size * size * 3);
    for (let i = 0; i < size * size; i++) {
        arr[i*3+0] = data[i*4+0] / 127.5 - 1;
        arr[i*3+1] = data[i*4+1] / 127.5 - 1;
        arr[i*3+2] = data[i*4+2] / 127.5 - 1;
    }
    return new ort.Tensor('float32', arr, [1, size, size, 3]);
}

// Handle image upload
document.getElementById('imageInput').addEventListener('change', function(e) {
    let file = e.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(ev) {
        let img = document.getElementById('preview');
        img.src = ev.target.result;
        img.style.display = 'block';
        img.onload = function() {
            imageTensor = preprocessImage(img);
        }
    };
    reader.readAsDataURL(file);
});

let treatments = [];

// Load treatment.json
fetch('skincare_product/treatment.json')
    .then(res => res.json())
    .then(data => { treatments = data; });

// Fungsi untuk mencari gambar produk dengan berbagai ekstensi
function findProductImage(id) {
    const exts = ['png', 'jpg', 'webp'];
    for (let ext of exts) {
        let path = `skincare_product/gambar_produk/${id}.${ext}`;
        if (imageExists(path)) return path;
        // mengulangi jika tidak ada
    }
}

// Cek apakah gambar ada (asynchronous workaround)
function imageExists(url) {
    // Karena JS di browser tidak bisa sync check file, kita pakai img onerror di HTML
    // Fungsi ini hanya untuk urutan prioritas, bukan benar-benar cek file ada
    return true;
}

// Fungsi tampilkan rekomendasi produk
function showRecommendations(tag) {
    let produk = treatments.filter(row => row.Tags.toLowerCase() === tag.toLowerCase());
    if (produk.length === 0) {
        return `<div class="alert alert-warning mt-3">Tidak ada rekomendasi produk untuk kategori ini.</div>`;
    }
    let html = `<h4 class="mt-4 mb-3">Rekomendasi Produk:</h4>`;
    produk.forEach(row => {
        let imgPath = findProductImage(row.Id);
        html += `
        <div class="card card-product shadow-sm p-2">
            <div class="row g-0 align-items-center">
                <div class="col-auto">
                    <img src="${imgPath}" alt="produk" class="me-3"
                        onerror="this.style.display='none'">
                </div>
                <div class="col">
                    <div class="card-body py-2 px-2">
                        <b>${row.Brand}</b> | ${row["Product Name"]} <br>
                        <span class="text-success">${row.Price}</span><br>
                        <a href="${row.Links}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">Lihat Produk</a>
                    </div>
                </div>
            </div>
        </div>`;
    });
    return html;
}

document.getElementById('predictBtn').addEventListener('click', async function() {
    if (!session || !imageTensor) {
        document.getElementById('result').innerHTML = `<div class="alert alert-danger">Model atau gambar belum siap.</div>`;
        return;
    }
    document.getElementById('result').innerHTML = `<div class="text-secondary">Memproses...</div>`;
    try {
        const feeds = {};
        feeds[session.inputNames[0]] = imageTensor;
        const output = await session.run(feeds);
        const outputTensor = output[session.outputNames[0]].data;
        let maxIdx = 0, maxVal = outputTensor[0];
        for (let i = 1; i < outputTensor.length; i++) {
            if (outputTensor[i] > maxVal) {
                maxVal = outputTensor[i];
                maxIdx = i;
            }
        }
        let resultHTML = `
            <div class="alert alert-info">
                <b>Prediksi:</b> ${categories[maxIdx]}<br>
                <b>Confidence:</b> ${(maxVal*100).toFixed(2)}%
            </div>
        `;
        resultHTML += showRecommendations(categories[maxIdx]);
        document.getElementById('result').innerHTML = resultHTML;
    } catch (err) {
        document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
    }
});
</script>
</body>
</html>